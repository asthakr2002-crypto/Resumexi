<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - ResumeX AI</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="gradient-bg"></div>
    <div class="dashboard-layout">
        <aside class="sidebar glass-card"
            style="border-radius: 0; border: none; border-right: 1px solid var(--glass-border);">
            <div class="logo" style="margin-bottom: 3rem;">
                <i data-lucide="sparkles" class="primary-text" style="color: var(--primary);"></i>
                <span>ResumeX AI</span>
            </div>

            <nav style="flex-direction: column; align-items: flex-start; gap: 1rem; padding: 0;">
                <a href="dashboard.html"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; width: 100%; border-radius: 0.5rem; background: var(--primary); color: white;">
                    <i data-lucide="layout-dashboard"></i> Dashboard
                </a>
                <a href="analyzer.html"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; width: 100%; border-radius: 0.5rem; color: var(--text-secondary);">
                    <i data-lucide="upload"></i> Upload Resume
                </a>
                <a href="#"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; width: 100%; border-radius: 0.5rem; color: var(--text-secondary);">
                    <i data-lucide="history"></i> History
                </a>
                <a href="#"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; width: 100%; border-radius: 0.5rem; color: var(--text-secondary);">
                    <i data-lucide="user"></i> Profile
                </a>
            </nav>

            <div style="margin-top: auto; padding-top: 2rem; border-top: 1px solid var(--glass-border);">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2rem;">
                    <div style="width: 2.5rem; height: 2.5rem; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center; font-weight: bold;"
                        id="user-avatar">?</div>
                    <div>
                        <div style="font-size: 0.875rem; font-weight: 600;" id="user-name">Loading...</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);" id="user-role">User</div>
                    </div>
                </div>
                <button id="logout-btn"
                    style="display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; width: 100%; border-radius: 0.5rem; color: #ef4444; background: none; border: none; cursor: pointer; font-weight: 500;">
                    <i data-lucide="log-out"></i> Logout
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header style="margin-bottom: 3rem;">
                <h1 style="font-size: 2rem; margin-bottom: 0.5rem;">Welcome Back!</h1>
                <p style="color: var(--text-secondary);">Here's an overview of your career acceleration progress.</p>
            </header>

            <div class="grid" style="grid-template-columns: repeat(4, 1fr); margin-bottom: 3rem;">
                <div class="glass-card" style="padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="padding: 0.75rem; border-radius: 0.75rem; background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        <i data-lucide="file-text"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Total Analysis</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="stat-total">0</div>
                    </div>
                </div>
                <div class="glass-card" style="padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="padding: 0.75rem; border-radius: 0.75rem; background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        <i data-lucide="trending-up"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Avg. Score</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="stat-avg">0%</div>
                    </div>
                </div>
                <div class="glass-card" style="padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="padding: 0.75rem; border-radius: 0.75rem; background: rgba(168, 85, 247, 0.1); color: #a855f7;">
                        <i data-lucide="award"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Highest Score</div>
                        <div style="font-size: 1.5rem; font-weight: 700;" id="stat-high">0%</div>
                    </div>
                </div>
                <div class="glass-card" style="padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                    <div
                        style="padding: 0.75rem; border-radius: 0.75rem; background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        <i data-lucide="zap"></i>
                    </div>
                    <div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary);">Plan</div>
                        <div style="font-size: 1.5rem; font-weight: 700;">Free</div>
                    </div>
                </div>
            </div>

            <div class="grid" style="grid-template-columns: 2fr 1fr;">
                <div class="glass-card" style="padding: 2rem;">
                    <h3 style="margin-bottom: 2rem;">Score Progression</h3>
                    <canvas id="scoreChart" height="200"></canvas>
                </div>
                <div class="glass-card"
                    style="padding: 2rem; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                    <h3 style="margin-bottom: 2rem; align-self: flex-start;">Latest Match</h3>
                    <div style="position: relative; width: 200px; height: 200px;">
                        <canvas id="doughnutChart"></canvas>
                        <div
                            style="position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;">
                            <span style="font-size: 2.5rem; font-weight: 800;" id="latest-score-text">0%</span>
                            <span style="font-size: 0.75rem; color: var(--text-secondary);">Match</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/api.js"></script>
    <script>
        lucide.createIcons();

        const user = JSON.parse(localStorage.getItem('user') || '{}');
        if (!user.token) window.location.href = 'login.html';

        document.getElementById('user-name').textContent = user.name;
        document.getElementById('user-role').textContent = user.role;
        document.getElementById('user-avatar').textContent = user.name.charAt(0);

        document.getElementById('logout-btn').onclick = () => {
            localStorage.clear();
            window.location.href = 'login.html';
        };

        async function initDashboard() {
            try {
                const history = await API.getHistory();

                document.getElementById('stat-total').textContent = history.length;
                if (history.length > 0) {
                    const avg = history.reduce((a, b) => a + b.atsScore, 0) / history.length;
                    const high = Math.max(...history.map(r => r.atsScore));
                    const latest = history[0].atsScore;

                    document.getElementById('stat-avg').textContent = avg.toFixed(1) + '%';
                    document.getElementById('stat-high').textContent = high.toFixed(1) + '%';
                    document.getElementById('latest-score-text').textContent = latest.toFixed(0) + '%';

                    // Charts
                    new Chart(document.getElementById('scoreChart'), {
                        type: 'bar',
                        data: {
                            labels: history.slice(0, 7).reverse().map((_, i) => 'Analysis ' + (i + 1)),
                            datasets: [{
                                label: 'ATS Score',
                                data: history.slice(0, 7).reverse().map(r => r.atsScore),
                                backgroundColor: 'rgba(99, 102, 241, 0.5)',
                                borderColor: '#6366f1',
                                borderWidth: 1
                            }]
                        },
                        options: { scales: { y: { beginAtZero: true, max: 100 } } }
                    });

                    new Chart(document.getElementById('doughnutChart'), {
                        type: 'doughnut',
                        data: {
                            datasets: [{
                                data: [latest, 100 - latest],
                                backgroundColor: ['#6366f1', 'rgba(255, 255, 255, 0.05)'],
                                borderWidth: 0
                            }]
                        },
                        options: { cutout: '80%', plugins: { legend: { display: false } } }
                    });
                }
            } catch (err) {
                console.error(err);
            }
        }

        initDashboard();
    </script>
</body>

</html>